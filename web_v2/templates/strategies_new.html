<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/lucide-static@latest/icons.css" rel="stylesheet">
<script>
  function generateTPRows() {
    const count = parseInt(document.getElementById('tp_count').value);
    const container = document.getElementById('tp_table');
    document.getElementById("tp_count_hidden").value = count;
    container.innerHTML = '';

    for (let i = 1; i <= count; i++) {
      container.innerHTML += `
        <tr class="border-t">
          <td class="px-3 py-2">${i}</td>
          <td>
            <input type="number" name="volume_${i}" step="any" class="w-full px-2 py-1 border rounded" placeholder="%" />
          </td>
          <td>
            <select name="tp_type_${i}" class="w-full px-2 py-1 border rounded" onchange="toggleTPValueInput(${i}, this.value)">
              <option value="">–í—ã–±–æ—Ä...</option>
              <option value="percent">percent</option>
              <option value="atr">atr</option>
              <option value="fixed">fixed</option>
              <option value="external_signal">external_signal</option>
            </select>
          </td>
          <td id="tp_value_cell_${i}"></td>
        </tr>`;
    }
  }

  function toggleTPValueInput(level, type) {
    const cell = document.getElementById(`tp_value_cell_${level}`);
    
    if (type === 'external_signal') {
      const isReverse = document.querySelector('input[name="reverse"]')?.checked === true;
      let options = '<option value="">–í—ã–±–æ—Ä...</option>';

      if (isReverse) {
        options += '<option value="__USE_ACTION_SIGNAL__">–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–∏–≥–Ω–∞–ª</option>';
      }

      const template = document.getElementById("exit-signal-options");
      if (template) {
        options += template.innerHTML;
      }

      cell.innerHTML = `
        <select name="tp_value_${level}" class="w-full px-2 py-1 border rounded">
          ${options}
        </select>`;
    } else if (['percent', 'atr', 'fixed'].includes(type)) {
      cell.innerHTML = `
        <input name="tp_value_${level}" type="number" step="any" class="w-full px-2 py-1 border rounded" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" />`;
    } else {
      cell.innerHTML = '';
    }
  }

  function handleTickerToggle() {
    const checkboxes = document.querySelectorAll('.ticker-checkbox');
    const allTickersCheckbox = document.getElementById('use_all_tickers');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    allTickersCheckbox.disabled = !allChecked;
    allTickersCheckbox.checked = allChecked;
  }

  function handleAllTickersToggle() {
    const state = document.getElementById('use_all_tickers').checked;
    const checkboxes = document.querySelectorAll('.ticker-checkbox');
    checkboxes.forEach(cb => cb.checked = state);
    document.getElementById('use_all_tickers').disabled = state;
  }
</script>
    <style>
      body {
        background: linear-gradient(to bottom right, #e0f2ff, #fde2e4);
      }
    </style>
  </head>
  <body class="min-h-screen font-sans text-slate-800">
    <!-- üî∏ Topbar Navigation -->
    <header class="w-full bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-blue-900 tracking-wide">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –¢–æ—Ä–≥–æ–≤–ª—è</h1>
        <nav class="space-x-4 text-sm font-medium text-slate-700">
          <a href="/" class="hover:text-blue-600 transition-colors">–ì–ª–∞–≤–Ω–∞—è</a>
          <a href="/tickers" class="hover:text-blue-600 transition-colors">–¢–∏–∫–µ—Ä—ã</a>
          <a href="/indicators" class="hover:text-blue-600 transition-colors">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</a>
          <a href="/signals" class="hover:text-blue-600 transition-colors">–°–∏–≥–Ω–∞–ª—ã</a>
          <a href="/strategies" class="text-blue-700 font-semibold">–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</a>
        </nav>
      </div>
    </header>

    <!-- üî∏ Page Content -->
    <main class="max-w-7xl mx-auto px-4 py-10">
<form method="POST" action="/strategies/new" class="space-y-10">    
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-semibold text-blue-900">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
      </div>
<!-- üîπ –ë–ª–æ–∫ 1: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="max-w-4xl mx-auto px-6 py-8 bg-white/80 rounded-2xl shadow-xl space-y-10">
  <section class="space-y-4">
    <h3 class="text-xl font-semibold text-blue-800">–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
    <input name="name" id="strategy_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full px-3 py-2 border rounded" />
    <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="w-full px-3 py-2 border rounded"></textarea>
    <div class="grid grid-cols-3 gap-4">
      <input name="deposit" id="deposit" type="number" class="w-full px-3 py-2 border rounded" placeholder="–î–µ–ø–æ–∑–∏—Ç" />
      <input name="position_limit" id="position_limit" type="number" step="1" min="1" class="w-full px-3 py-2 border rounded" placeholder="–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏" />
      <input name="max_risk" id="max_risk" type="number" step="1" min="1" max="10" class="w-full px-3 py-2 border rounded" placeholder="–ú–∞–∫—Å. —Ä–∏—Å–∫, %" />
    </div>
    <input name="leverage" id="leverage" type="number" step="1" min="1" max="50" class="w-full px-3 py-2 border rounded" placeholder="–ü–ª–µ—á–æ (leverage)" />
<select name="action_signal_id" id="action_signal_id" class="w-full px-3 py-2 border rounded">
  <option value="">–í—ã–±–æ—Ä —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞...</option>
  {% for s in signals %}
    <option value="{{ s.id }}">{{ s.name }} [{{ 'enabled' if s.enabled else 'disabled' }}]</option>
  {% endfor %}
</select>
    <select name="timeframe" id="timeframe" class="w-full px-3 py-2 border rounded">
      <option>–í—ã–±–æ—Ä —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞...</option>
      <option>M1</option>
      <option>M5</option>
      <option>M15</option>
    </select>
    <label class="inline-flex items-center space-x-2 text-sm text-slate-700">
      <input name="reverse" type="checkbox" />
      <span>–†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–≤–µ—Ä—Å—ã (reverse)</span>
    </label>
    <input type="hidden" id="reverse_flag" value="{{ 'true' if reverse else 'false' }}">
  </section>
</div>
<br>
<!-- üîπ –ë–ª–æ–∫ 2: SL -->
<div class="max-w-4xl mx-auto px-6 py-8 bg-white/80 rounded-2xl shadow-xl space-y-10">
  <section class="space-y-4">
    <h3 class="text-xl font-semibold text-blue-800">Stop-Loss</h3>
    <label><input name="use_stoploss" type="checkbox" checked /> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SL</label>
    <select name="sl_type" class="w-full px-3 py-2 border rounded" id="sl_type">
      <option>–í—ã–±–æ—Ä —Ç–∏–ø–∞ SL...</option>
      <option value="percent">percent</option>
      <option value="atr">atr</option>
    </select>
    <input name="sl_value" id="sl_value" type="number" step="any" class="w-full px-3 py-2 border rounded" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ SL" />
  </section>
</div>
<br>
      <!-- üîπ –ë–ª–æ–∫ 3: TP -->
      <div class="max-w-4xl mx-auto px-6 py-8 bg-white/80 rounded-2xl shadow-xl space-y-10">
      <section class="space-y-4">
        <h3 class="text-xl font-semibold text-blue-800">Take Profit</h3>
        <select id="tp_count" onchange="generateTPRows()" class="w-full px-3 py-2 border rounded">
          <option value="">–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Ä–æ–≤–Ω–µ–π...</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
        <table class="w-full table-auto text-sm text-left border rounded">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-3 py-2">#</th>
              <th class="px-3 py-2">–û–±—ä—ë–º, %</th>
              <th class="px-3 py-2">–¢–∏–ø TP</th>
              <th class="px-3 py-2">–ó–Ω–∞—á–µ–Ω–∏–µ / –°–∏–≥–Ω–∞–ª</th>
            </tr>
          </thead>
          <tbody id="tp_table" class="bg-white/80"></tbody>
        </table>
      </section>
      </div>
      <br>
<!-- üîπ –ë–ª–æ–∫ 4: –¢–∏–∫–µ—Ä—ã -->
<div class="max-w-4xl mx-auto px-6 py-8 bg-white/80 rounded-2xl shadow-xl space-y-10">
  <section class="space-y-4">
    <h3 class="text-xl font-semibold text-blue-800 flex items-center justify-between">
      –¢–∏–∫–µ—Ä—ã
      <label class="text-sm">
        <input name="use_all_tickers" type="checkbox" id="use_all_tickers" checked onchange="handleAllTickersToggle()" />
        –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ
      </label>
    </h3>

    <!-- üîπ –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ TP -->
    <input type="hidden" id="tp_count_hidden" name="tp_count" />
    <table class="w-full table-auto text-sm text-left border rounded">
      <thead class="bg-slate-100">
        <tr>
          <th class="px-3 py-2">#</th>
          <th class="px-3 py-2">–¢–∏–∫–µ—Ä</th>
          <th class="px-3 py-2">–°—Ç–∞—Ç—É—Å</th>
          <th class="px-3 py-2">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</th>
          <th class="px-3 py-2">‚úÖ</th>
        </tr>
      </thead>
      <tbody class="bg-white/80">
        {% for t in tickers %}
        <tr>
          <td class="px-3 py-2">{{ loop.index }}</td>
          <td>{{ t.symbol }}</td>
          <td>{{ t.status }}</td>
          <td>{{ t.tradepermission }}</td>
          <td>
            <input name="ticker_{{ t.symbol }}" type="checkbox" checked class="ticker-checkbox" onchange="handleTickerToggle()" />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>
<br>
      <!-- üîπ –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
      <div class="text-center">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl shadow hover:bg-blue-700 hover:shadow-lg transition-all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
      </div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");

    form.addEventListener("submit", function (e) {
      // üîπ –ù–∞–∑–≤–∞–Ω–∏–µ
      const name = document.getElementById("strategy_name")?.value.trim();
      const nameRegex = /^[A-Za-z_]+$/;
      if (!name) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–ù–∞–∑–≤–∞–Ω–∏–µ' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
        return;
      }
      if (!nameRegex.test(name)) {
        e.preventDefault();
        alert("–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Å–∏–º–≤–æ–ª –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è (_).");
        return;
      }

      // üîπ –î–µ–ø–æ–∑–∏—Ç
      const deposit = document.getElementById("deposit")?.value.trim();
      if (!deposit || !/^\d+$/.test(deposit)) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–î–µ–ø–æ–∑–∏—Ç' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.");
        return;
      }

      // üîπ –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
      const positionLimit = document.getElementById("position_limit")?.value.trim();
      if (!positionLimit || !/^\d+$/.test(positionLimit)) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.");
        return;
      }

      // üîπ –ú–∞–∫—Å. —Ä–∏—Å–∫
      const maxRisk = document.getElementById("max_risk")?.value.trim();
      if (!maxRisk || !/^\d+$/.test(maxRisk)) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.");
        return;
      }
      if (parseInt(maxRisk, 10) > 10) {
        e.preventDefault();
        alert("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10%.");
        return;
      }

      // üîπ –ü–ª–µ—á–æ
      const leverage = document.getElementById("leverage")?.value.trim();
      if (!leverage || !/^\d+$/.test(leverage)) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–ü–ª–µ—á–æ' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.");
        return;
      }
      if (parseInt(leverage, 10) > 50) {
        e.preventDefault();
        alert("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–ª–µ—á–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50.");
        return;
      }

      // üîπ –£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–∏–≥–Ω–∞–ª
      const selectedSignal = document.getElementById("action_signal_id")?.value;
      if (!selectedSignal) {
        e.preventDefault();
        alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–∏–≥–Ω–∞–ª.");
        return;
      }

      // üîπ –¢–∞–π–º—Ñ—Ä–µ–π–º
      const selectedTimeframe = document.getElementById("timeframe")?.value;
      if (!selectedTimeframe) {
        e.preventDefault();
        alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ç–∞–π–º—Ñ—Ä–µ–π–º.");
        return;
      }

      // üîπ –¢–∏–ø SL
      const slType = document.getElementById("sl_type")?.value;
      if (!slType) {
        e.preventDefault();
        alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø SL.");
        return;
      }

      // üîπ –ó–Ω–∞—á–µ–Ω–∏–µ SL
      const slValue = document.getElementById("sl_value")?.value.trim();
      if (!slValue || !/^\d+(\.\d+)?$/.test(slValue)) {
        e.preventDefault();
        alert("–ü–æ–ª–µ '–ó–Ω–∞—á–µ–Ω–∏–µ SL' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.3).");
        return;
      }

      // üîπ TP —É—Ä–æ–≤–Ω–∏
      const tpCount = parseInt(document.getElementById("tp_count_hidden")?.value || "0");
      let totalVolume = 0;

      for (let i = 1; i <= tpCount; i++) {
        const tpType = document.querySelector(`[name="tp_type_${i}"]`)?.value;
        const volumeStr = document.querySelector(`[name="volume_${i}"]`)?.value.trim();
        const valueStr = document.querySelector(`[name="tp_value_${i}"]`)?.value.trim();

        // üî∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä—ë–º–∞
        if (!volumeStr || !/^\d+(\.\d+)?$/.test(volumeStr)) {
          e.preventDefault();
          alert(`TP —É—Ä–æ–≤–µ–Ω—å ${i}: –ø–æ–ª–µ '–û–±—ä—ë–º' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.`);
          return;
        }

        totalVolume += parseFloat(volumeStr);

        // üî∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è TP (–µ—Å–ª–∏ –Ω–µ external_signal)
        if (tpType !== "external_signal") {
          if (!valueStr || !/^\d+(\.\d+)?$/.test(valueStr)) {
            e.preventDefault();
            alert(`TP —É—Ä–æ–≤–µ–Ω—å ${i}: –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.3).`);
            return;
          }
        }
      }

      if (Math.round(totalVolume) !== 100) {
        e.preventDefault();
        alert(`–°—É–º–º–∞ –æ–±—ä—ë–º–æ–≤ –≤—Å–µ—Ö TP —É—Ä–æ–≤–Ω–µ–π –¥–æ–ª–∂–Ω–∞ —Ä–∞–≤–Ω—è—Ç—å—Å—è 100. –°–µ–π—á–∞—Å: ${totalVolume}`);
        return;
      }

      // üîπ –¢–∏–∫–µ—Ä—ã
      const useAllTickers = document.getElementById("use_all_tickers")?.checked;
      if (!useAllTickers) {
        const checkboxes = document.querySelectorAll(".ticker-checkbox");
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (!anyChecked) {
          e.preventDefault();
          alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–∫–µ—Ä.");
          return;
        }
      }
    });
  });
</script>
</form>      
    </main>
<template id="exit-signal-options">
  {% for s in exit_signals %}
    <option value="{{ s.id }}">{{ s.name }} [{{ 'enabled' if s.enabled else 'disabled' }}]</option>
  {% endfor %}
</template>    
  </body>
</html>
